// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MODELS ====================

model User {
  id              String    @id @default(cuid())
  name            String?   @db.VarChar(100)
  email           String    @unique @db.VarChar(255)
  password        String    @db.VarChar(255)
  avatar          String?
  bio             String?   @db.VarChar(500)
  isEmailVerified Boolean   @default(false)
  refreshToken    String?   @db.Text
  otp             String?   @db.VarChar(10)
  otpExpiry       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  settings         UserSettings?
  playlists        Playlist[]
  library          Library?
  sessions         Session[]
  chatMessages     ChatMessage[]
  recentlyPlayed   RecentlyPlayed[]
  recentSearches   RecentSearch[]

  // Collaborative playlists
  collaboratingOn  Playlist[] @relation("PlaylistCollaborators")

  // Session participants
  sessionParticipants SessionParticipant[]

  @@index([email])
  @@index([createdAt(sort: Desc)])
  @@map("users")
}

model UserSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Audio Quality
  audioQuality        String   @default("high") // low, medium, high, very_high

  // Playback Settings
  crossfadeDuration   Int      @default(0) // 0-12 seconds
  gaplessPlayback     Boolean  @default(true)
  normalizeVolume     Boolean  @default(false)
  playbackSpeed       Float    @default(1.0) // 0.5-2.0

  // Equalizer
  equalizerEnabled    Boolean  @default(false)
  equalizerPreset     String   @default("flat") // flat, rock, pop, jazz, classical, electronic, hip-hop, custom

  // Equalizer Bands (-12 to +12)
  band32              Int      @default(0)
  band64              Int      @default(0)
  band125             Int      @default(0)
  band250             Int      @default(0)
  band500             Int      @default(0)
  band1k              Int      @default(0)
  band2k              Int      @default(0)
  band4k              Int      @default(0)
  band8k              Int      @default(0)
  band16k             Int      @default(0)

  // Lyrics
  lyricsEnabled       Boolean  @default(true)
  lyricsLanguage      String   @default("en") @db.VarChar(10)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@map("user_settings")
}

// ==================== PLAYLIST MODELS ====================

model Playlist {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String    @db.VarChar(255)
  desc            String    @default("") @db.Text
  banner          String?

  // Songs stored as array of IDs (referencing external song collection)
  songIds         String[]  @default([])

  isPublic        Boolean   @default(false)
  collaborative   Boolean   @default(false)

  // Collaborators
  collaborators   User[]    @relation("PlaylistCollaborators")

  shuffleEnabled  Boolean   @default(false)
  loopMode        String    @default("off") // off, one, all

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, createdAt(sort: Desc)])
  @@index([isPublic])
  @@map("playlists")
}

// ==================== LIBRARY MODEL ====================

model Library {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Store as arrays of song/album IDs
  likedSongIds    String[]  @default([])
  likedAlbumIds   String[]  @default([])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("libraries")
}

// ==================== SESSION MODELS ====================

model Session {
  id              String    @id @default(cuid())
  sessionCode     String    @unique @db.VarChar(10)
  name            String    @default("Listening Party") @db.VarChar(255)
  hostId          String
  host            User      @relation(fields: [hostId], references: [id], onDelete: Cascade)

  isActive        Boolean   @default(true)
  privacy         String    @default("private") // public, private, friends-only

  // Current playback state
  currentSongId   String?
  currentTime     Float     @default(0)
  isPlaying       Boolean   @default(false)

  // Queue (array of song IDs)
  queueIds        String[]  @default([])

  // Settings
  allowGuestControl Boolean @default(true)
  allowQueueAdd     Boolean @default(true)
  maxParticipants   Int     @default(10)

  lastUpdate      DateTime  @default(now())
  expiresAt       DateTime  @default(dbgenerated("NOW() + INTERVAL '24 hours'"))

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  participants    SessionParticipant[]
  chatMessages    ChatMessage[]

  @@index([sessionCode])
  @@index([expiresAt])
  @@map("sessions")
}

model SessionParticipant {
  id              String    @id @default(cuid())
  sessionId       String
  session         Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  joinedAt        DateTime  @default(now())
  isOnline        Boolean   @default(true)

  // Permissions
  canControl      Boolean   @default(true)
  canAddToQueue   Boolean   @default(true)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@map("session_participants")
}

model ChatMessage {
  id              String    @id @default(cuid())
  sessionId       String
  session         Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  message         String    @db.VarChar(500)
  type            String    @default("text") // text, system, reaction, song

  // Song context (optional)
  songContextId   String?
  songTimestamp   Float?

  // Reactions stored as JSON
  reactions       Json      @default("[]")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([sessionId, createdAt(sort: Desc)])
  @@map("chat_messages")
}

// ==================== HISTORY MODELS ====================

model RecentlyPlayed {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  songId          String

  playDuration    Int       @default(0) // seconds
  skipped         Boolean   @default(false)
  contextType     String?   @db.VarChar(50) // playlist, album, liked, search
  contextId       String?

  playedAt        DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, playedAt(sort: Desc)])
  @@map("recently_played")
}

model RecentSearch {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  query           String    @db.VarChar(255)
  type            String    @default("query") // song, album, user, query
  resultId        String?

  searchedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())

  @@index([userId, searchedAt(sort: Desc)])
  @@map("recent_searches")
}

// ==================== RECOMMENDATION MODEL ====================

model Recommendation {
  id                String    @id @default(cuid())
  songId            String    @unique

  globalPlayCount   Int       @default(0)
  globalSkipCount   Int       @default(0)
  weightedScore     Float     @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([songId])
  @@index([weightedScore(sort: Desc)])
  @@map("recommendations")
}

// ==================== LYRICS MODEL ====================

model Lyrics {
  id              String    @id @default(cuid())
  songId          String    @unique

  plainLyrics     String    @default("") @db.Text

  // Synced lyrics stored as JSON array
  syncedLyrics    Json      @default("[]")

  language        String    @default("en") @db.VarChar(10)
  source          String    @default("manual") // manual, musixmatch, genius, lrclib, other
  isVerified      Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([songId])
  @@map("lyrics")
}
